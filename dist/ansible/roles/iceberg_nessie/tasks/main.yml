---
    - name: Stop Spark master on master node
      when: inventory_hostname in groups['spark_master']
      systemd:
        name: spark-master
        state: stopped
        enabled: true

    - name: Stop Spark worker on worker nodes
      when: inventory_hostname in groups['spark_workers']
      systemd:
        name: spark-slave
        state: stopped
        enabled: true

    - name: Extract ivy cache tarball
      unarchive:
        src: "{{ spark_airgap_ivy_cache }}"
        dest: "{{ spark_user_registered.home }}"
        remote_src: no
        owner: "{{ spark_user }}"
        group: "{{ org_group }}"
        creates: "{{ spark_user_registered.home }}/,ivy/cache"

    - name: Move existing cache ivy files to the new ivy directory
      command: "mv {{ spark_user_registered.home }}/.ivy/* {{ spark_user_registered.home }}/airgap/.ivy/"

    - name: Delete content & directory
      ansible.builtin.file:
        state: absent
        path: {{ spark_user_registered.home }}/.ivy

    - name: Finally move backk ALL ivy cached content
      command: mv {{ spark_user_registered.home }}/airgap/.ivy {{ spark_user_registered.home }}/.ivy
      args:
        creates: "{{ spark_user_registered.home }}/.ivy"

    - name: Start Spark master on worker nodes
      when: inventory_hostname in groups['spark_master']
      systemd:
        name: spark-master
        state: started
        enabled: true

    - name: Start Spark worker on worker nodes
      when: inventory_hostname in groups['spark_workers']
      systemd:
        name: spark-slave
        state: started
        enabled: true
